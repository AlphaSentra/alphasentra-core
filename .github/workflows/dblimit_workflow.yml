name: Daily DB Limit Check
on:
  schedule:
    - cron: '0 15 * * *'  # 3pm UTC every day
  workflow_dispatch:

jobs:
  run-dblimit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env from secrets
        run: |
          # Use simplest format for simple values (no quotes needed)
          echo USE_MONGODB_SRV=${{ secrets.USE_MONGODB_SRV }} >> .env
          
          # For MONGODB_SRV: Remove the extra single quotes to avoid parsing errors. 
          # The value will be a single string, as required by python-dotenv.
          echo MONGODB_SRV=${{ secrets.MONGODB_SRV }} >> .env
          
          echo MONGODB_HOST=${{ secrets.MONGODB_HOST }} >> .env
          echo MONGODB_PORT=${{ secrets.MONGODB_PORT }} >> .env
          echo MONGODB_DATABASE=${{ secrets.MONGODB_DATABASE }} >> .env
          echo MONGODB_USERNAME=${{ secrets.MONGODB_USERNAME }} >> .env
          echo MONGODB_PASSWORD=${{ secrets.MONGODB_PASSWORD }} >> .env
          echo MONGODB_AUTH_SOURCE=${{ secrets.MONGODB_AUTH_SOURCE }} >> .env
          
          # For GEMINI_API_KEY: Keep this format, but be aware your Python code 
          # must now explicitly parse this string as a JSON/Python list.
          echo GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} >> .env
          
          echo GEMINI_DEFAULT=${{ secrets.GEMINI_DEFAULT }} >> .env
          echo GEMINI_FLASH_MODEL=${{ secrets.GEMINI_FLASH_MODEL }} >> .env
          echo GEMINI_PRO_MODEL=${{ secrets.GEMINI_PRO_MODEL }} >> .env
          echo ENCRYPTION_SECRET=${{ secrets.ENCRYPTION_SECRET }} >> .env

      - name: Run DB limit check
        run: python main.py -dblimit